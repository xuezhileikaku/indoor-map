<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>室内地图编辑器</title>
    <script src="https://unpkg.com/konva@8.4.3/konva.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        .container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }
        .tools {
            width: 200px;
            background-color: #f0f0f0;
            padding: 10px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .canvas-container {
            flex: 1;
            background-color: #e5e5e5;
        }
        .tool-section {
            margin-bottom: 20px;
        }
        .tool-section h3 {
            margin-top: 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }
        .tool-btn {
            display: block;
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
            background-color: #fff;
            border: 1px solid #ddd;
            cursor: pointer;
            text-align: center;
            border-radius: 4px;
        }
        .tool-btn:hover {
            background-color: #eaeaea;
        }
        .tool-btn.active {
            background-color: #4CAF50;
            color: white;
        }
        .color-picker {
            margin-top: 5px;
            width: 100%;
        }
        #coordsInfo {
            position: absolute;
            bottom: 10px;
            left: 220px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
        }
        .info-text {
            position: absolute;
            bottom: 50px;
            left: 220px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tools">
            <div class="tool-section">
                <h3>绘制工具</h3>
                <button class="tool-btn" id="rectangle">矩形房间</button>
                <button class="tool-btn" id="polygon">多边形房间</button>
                <button class="tool-btn" id="circle">圆形展位</button>
                <button class="tool-btn" id="star">星形展位</button>
            </div>

            <div class="tool-section">
                <h3>颜色</h3>
                <label>填充颜色</label>
                <input type="color" id="fillColor" class="color-picker" value="#ffffff">
                <label>边框颜色</label>
                <input type="color" id="strokeColor" class="color-picker" value="#000000">
            </div>

            <div class="tool-section">
                <h3>操作</h3>
                <button class="tool-btn" id="select">选择</button>
                <button class="tool-btn" id="delete">删除选中</button>
                <button class="tool-btn" id="clear">清空画布</button>
            </div>
        </div>
        <div class="canvas-container" id="canvas-container"></div>
        <div id="coordsInfo">坐标信息会显示在这里</div>
        <div id="infoText" class="info-text"></div>
    </div>

    <script>
        // 初始化Konva舞台
        const width = document.getElementById('canvas-container').clientWidth;
        const height = document.getElementById('canvas-container').clientHeight;

        const stage = new Konva.Stage({
            container: 'canvas-container',
            width: width,
            height: height,
        });

        // 创建层
        const floorLayer = new Konva.Layer(); // 楼层背景
        const roomLayer = new Konva.Layer();  // 房间图层
        const tempLayer = new Konva.Layer();  // 临时绘制图层
        stage.add(floorLayer);
        stage.add(roomLayer);
        stage.add(tempLayer);

        // 创建背景楼层矩形
        const floorWidth = Math.min(width * 0.8, height * 0.8);
        const floorHeight = floorWidth * 0.75;
        const floorRect = new Konva.Rect({
            x: (width - floorWidth) / 2,
            y: (height - floorHeight) / 2,
            width: floorWidth,
            height: floorHeight,
            fill: '#f8f8f8',
            stroke: '#666',
            strokeWidth: 2,
            name: 'floor'
        });
        floorLayer.add(floorRect);
        floorLayer.draw(); // 确保立即绘制楼层

        // 状态变量
        let activeToolBtn = null;
        let isDrawing = false;
        let currentShape = null;
        let polygonPoints = [];
        let firstPoint = null;  // 多边形的第一个点，用于检测闭合
        let transformer = new Konva.Transformer({
            rotateEnabled: true,
            borderDash: [4, 4],
            boundBoxFunc: function(oldBoundBox, newBoundBox) {
                // 限制不要超出楼层边界
                const floorBox = floorRect.getClientRect();
                if (
                    newBoundBox.x < floorBox.x ||
                    newBoundBox.y < floorBox.y ||
                    newBoundBox.x + newBoundBox.width > floorBox.x + floorBox.width ||
                    newBoundBox.y + newBoundBox.height > floorBox.y + floorBox.height
                ) {
                    return oldBoundBox;
                }
                return newBoundBox;
            },
        });
        roomLayer.add(transformer);
        
        // 信息提示元素
        const infoText = document.getElementById('infoText');

        // 确保楼层正确显示
        window.addEventListener('load', function() {
            // 重新计算楼层矩形大小和位置
            const width = stage.width();
            const height = stage.height();
            const floorWidth = Math.min(width * 0.8, height * 0.8);
            const floorHeight = floorWidth * 0.75;
            
            floorRect.setAttrs({
                x: (width - floorWidth) / 2,
                y: (height - floorHeight) / 2,
                width: floorWidth,
                height: floorHeight
            });
            
            // 强制重绘
            floorLayer.batchDraw();
        });

        // 工具按钮处理函数
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // 重置其他按钮的状态
                if (activeToolBtn) {
                    activeToolBtn.classList.remove('active');
                }
                
                // 设置当前按钮状态
                this.classList.add('active');
                activeToolBtn = this;
                
                // 停止任何正在进行的绘制
                endCurrentDrawing();
                
                // 如果选择了"选择"工具，启用选择模式
                if (this.id === 'select') {
                    stage.container().style.cursor = 'default';
                    enableSelectionMode();
                    hideInfoText();
                } else if (this.id === 'polygon') {
                    disableSelectionMode();
                    stage.container().style.cursor = 'crosshair';
                    showInfoText("点击添加多边形顶点，双击或点击起点结束绘制");
                } else {
                    disableSelectionMode();
                    stage.container().style.cursor = 'crosshair';
                    hideInfoText();
                }
                
                // 如果选择了"删除"工具
                if (this.id === 'delete') {
                    deleteSelectedShape();
                    // 重置为选择模式
                    document.getElementById('select').click();
                }
                
                // 如果选择了"清空画布"工具
                if (this.id === 'clear') {
                    clearCanvas();
                    // 重置为选择模式
                    document.getElementById('select').click();
                }
            });
        });

        // 显示信息文本
        function showInfoText(text) {
            infoText.textContent = text;
            infoText.style.display = 'block';
        }

        // 隐藏信息文本
        function hideInfoText() {
            infoText.style.display = 'none';
        }

        // 结束当前绘制
        function endCurrentDrawing() {
            isDrawing = false;
            if (currentShape) {
                currentShape.remove();
                currentShape = null;
            }
            polygonPoints = [];
            firstPoint = null;
            tempLayer.draw();
            hideInfoText();
        }

        // 颜色选择器事件监听
        document.getElementById('fillColor').addEventListener('change', function() {
            if (transformer.nodes().length > 0) {
                transformer.nodes().forEach(node => {
                    node.fill(this.value);
                });
                roomLayer.batchDraw();
            }
        });

        document.getElementById('strokeColor').addEventListener('change', function() {
            if (transformer.nodes().length > 0) {
                transformer.nodes().forEach(node => {
                    node.stroke(this.value);
                });
                roomLayer.batchDraw();
            }
        });

        // 画布事件处理
        stage.on('mousedown', function(e) {
            // 确保有激活的工具按钮
            if (!activeToolBtn) return;
            
            // 获取点击位置
            const point = stage.getPointerPosition();
            
            // 确保点击在楼层矩形内部
            const floorBox = floorRect.getClientRect();
            if (
                point.x < floorBox.x ||
                point.y < floorBox.y ||
                point.x > floorBox.x + floorBox.width ||
                point.y > floorBox.y + floorBox.height
            ) {
                return;
            }
            
            // 根据当前工具进行绘制
            switch (activeToolBtn.id) {
                case 'rectangle':
                    isDrawing = true;
                    const rect = new Konva.Rect({
                        x: point.x,
                        y: point.y,
                        width: 0,
                        height: 0,
                        fill: document.getElementById('fillColor').value,
                        stroke: document.getElementById('strokeColor').value,
                        strokeWidth: 2,
                        draggable: false,
                        name: 'room'
                    });
                    currentShape = rect;
                    tempLayer.add(rect);
                    break;
                    
                case 'polygon':
                    // 如果尚未开始绘制多边形
                    if (!isDrawing) {
                        isDrawing = true;
                        polygonPoints = [point.x, point.y];
                        firstPoint = { x: point.x, y: point.y };
                        
                        currentShape = new Konva.Line({
                            points: polygonPoints,
                            fill: document.getElementById('fillColor').value,
                            stroke: document.getElementById('strokeColor').value,
                            strokeWidth: 2,
                            closed: false, // 初始设置为不闭合
                            name: 'room'
                        });
                        tempLayer.add(currentShape);
                        showInfoText("点击添加顶点，双击或点击起点结束绘制");
                    } else {
                        // 检查是否点击了起点(闭合多边形)
                        const distToFirst = Math.sqrt(
                            Math.pow(point.x - firstPoint.x, 2) + 
                            Math.pow(point.y - firstPoint.y, 2)
                        );
                        
                        if (distToFirst < 20 && polygonPoints.length > 4) {
                            // 点击了起点，闭合多边形
                            finishPolygon();
                        } else {
                            // 添加新顶点
                            polygonPoints.push(point.x);
                            polygonPoints.push(point.y);
                            currentShape.points(polygonPoints);
                            tempLayer.batchDraw();
                        }
                    }
                    break;
                    
                case 'circle':
                    isDrawing = true;
                    const circle = new Konva.Circle({
                        x: point.x,
                        y: point.y,
                        radius: 0,
                        fill: document.getElementById('fillColor').value,
                        stroke: document.getElementById('strokeColor').value,
                        strokeWidth: 2,
                        draggable: false,
                        name: 'booth'
                    });
                    currentShape = circle;
                    tempLayer.add(circle);
                    break;
                    
                case 'star':
                    isDrawing = true;
                    const star = new Konva.Star({
                        x: point.x,
                        y: point.y,
                        numPoints: 5,
                        innerRadius: 0,
                        outerRadius: 0,
                        fill: document.getElementById('fillColor').value,
                        stroke: document.getElementById('strokeColor').value,
                        strokeWidth: 2,
                        draggable: false,
                        name: 'booth'
                    });
                    currentShape = star;
                    tempLayer.add(star);
                    break;
            }
            
            tempLayer.draw();
        });

        stage.on('mousemove', function() {
            if (!isDrawing || !currentShape || !activeToolBtn) return;
            
            const pos = stage.getPointerPosition();
            
            switch (activeToolBtn.id) {
                case 'rectangle':
                    const startX = currentShape.attrs.x;
                    const startY = currentShape.attrs.y;
                    const width = pos.x - startX;
                    const height = pos.y - startY;
                    currentShape.width(width);
                    currentShape.height(height);
                    break;
                    
                case 'polygon':
                    // 更新多边形的最后一个点（用于实时预览）
                    // 如果我们只有一个点，添加一个临时点供线条显示
                    if (polygonPoints.length === 2) {
                        polygonPoints.push(pos.x);
                        polygonPoints.push(pos.y);
                    } else {
                        // 更新最后一个点
                        polygonPoints[polygonPoints.length - 2] = pos.x;
                        polygonPoints[polygonPoints.length - 1] = pos.y;
                    }
                    currentShape.points(polygonPoints);
                    
                    // 高亮显示起点，以便用户了解可以闭合多边形
                    const distToFirst = Math.sqrt(
                        Math.pow(pos.x - firstPoint.x, 2) + 
                        Math.pow(pos.y - firstPoint.y, 2)
                    );
                    
                    if (distToFirst < 20 && polygonPoints.length > 4) {
                        stage.container().style.cursor = 'pointer';
                        showInfoText("点击起点完成绘制");
                    } else {
                        stage.container().style.cursor = 'crosshair';
                        showInfoText("点击添加顶点，双击或点击起点结束绘制");
                    }
                    break;
                    
                case 'circle':
                    const startX2 = currentShape.attrs.x;
                    const startY2 = currentShape.attrs.y;
                    const dx = pos.x - startX2;
                    const dy = pos.y - startY2;
                    const radius = Math.sqrt(dx * dx + dy * dy);
                    currentShape.radius(radius);
                    break;
                    
                case 'star':
                    const startX3 = currentShape.attrs.x;
                    const startY3 = currentShape.attrs.y;
                    const dx2 = pos.x - startX3;
                    const dy2 = pos.y - startY3;
                    const radius2 = Math.sqrt(dx2 * dx2 + dy2 * dy2);
                    currentShape.outerRadius(radius2);
                    currentShape.innerRadius(radius2 / 2);
                    break;
            }
            
            tempLayer.batchDraw();
        });

        // 双击事件处理 - 主要用于完成多边形绘制
        stage.on('dblclick', function() {
            if (isDrawing && activeToolBtn && activeToolBtn.id === 'polygon' && polygonPoints.length >= 6) {
                finishPolygon();
            }
        });

        // 完成多边形绘制
        function finishPolygon() {
            if (polygonPoints.length < 6) return; // 至少需要3个点
            
            // 闭合多边形 - 不需要添加第一个点，因为我们设置了closed属性
            currentShape.closed(true);
            tempLayer.batchDraw();
            
            // 完成绘制
            finishDrawing();
        }

        stage.on('mouseup', function() {
            if (!isDrawing || !currentShape || !activeToolBtn) return;
            
            // 对于非多边形，鼠标抬起时完成绘图
            if (activeToolBtn.id !== 'polygon') {
                finishDrawing();
            }
        });

        // 完成绘图并添加到roomLayer
        function finishDrawing() {
            isDrawing = false;
            
            // 检查形状是否有效（比如不是一个点或一条线）
            let isValidShape = false;
            
            if (activeToolBtn.id === 'rectangle') {
                isValidShape = Math.abs(currentShape.width()) > 5 && Math.abs(currentShape.height()) > 5;
                // 处理负值宽度/高度
                if (currentShape.width() < 0) {
                    currentShape.x(currentShape.x() + currentShape.width());
                    currentShape.width(Math.abs(currentShape.width()));
                }
                if (currentShape.height() < 0) {
                    currentShape.y(currentShape.y() + currentShape.height());
                    currentShape.height(Math.abs(currentShape.height()));
                }
            } else if (activeToolBtn.id === 'polygon') {
                isValidShape = polygonPoints.length >= 6; // 至少3个点
            } else if (activeToolBtn.id === 'circle') {
                isValidShape = currentShape.radius() > 5;
            } else if (activeToolBtn.id === 'star') {
                isValidShape = currentShape.outerRadius() > 5;
            }
            
            if (isValidShape) {
                const newShape = currentShape.clone({
                    draggable: true,
                });
                
                roomLayer.add(newShape);
                
                // 为新形状添加事件处理
                addShapeEventHandlers(newShape);
                roomLayer.batchDraw();
            }
            
            // 清理临时图形
            currentShape.remove();
            currentShape = null;
            polygonPoints = [];
            firstPoint = null;
            tempLayer.draw();
            
            // 重置为选择模式
            document.getElementById('select').click();
        }

        // 为形状添加事件处理器
        function addShapeEventHandlers(shape) {
            shape.on('dragmove', function() {
                updateCoordsInfo();
                
                // 确保形状不超出楼层范围
                const floorBox = floorRect.getClientRect();
                const shapeBox = shape.getClientRect();
                
                if (shapeBox.x < floorBox.x) {
                    shape.x(shape.x() + (floorBox.x - shapeBox.x));
                }
                if (shapeBox.y < floorBox.y) {
                    shape.y(shape.y() + (floorBox.y - shapeBox.y));
                }
                if (shapeBox.x + shapeBox.width > floorBox.x + floorBox.width) {
                    shape.x(shape.x() - ((shapeBox.x + shapeBox.width) - (floorBox.x + floorBox.width)));
                }
                if (shapeBox.y + shapeBox.height > floorBox.y + floorBox.height) {
                    shape.y(shape.y() - ((shapeBox.y + shapeBox.height) - (floorBox.y + floorBox.height)));
                }
            });
            
            shape.on('click', function(e) {
                if (activeToolBtn && activeToolBtn.id === 'select') {
                    // 阻止事件冒泡到stage
                    e.cancelBubble = true;
                    
                    // 清除现有选择
                    transformer.nodes([]);
                    
                    // 添加新选择
                    transformer.nodes([shape]);
                    roomLayer.batchDraw();
                    
                    // 更新坐标信息
                    updateCoordsInfo();
                }
            });
            
            shape.on('transform', function() {
                updateCoordsInfo();
            });
        }

        // 启用选择模式
        function enableSelectionMode() {
            stage.on('click tap', function(e) {
                // 如果点击的是舞台背景（不是形状），则清除选择
                if (e.target === stage) {
                    transformer.nodes([]);
                    roomLayer.draw();
                    document.getElementById('coordsInfo').innerHTML = "坐标信息会显示在这里";
                }
            });
        }

        // 禁用选择模式
        function disableSelectionMode() {
            transformer.nodes([]);
            roomLayer.draw();
        }

        // 删除选中的形状
        function deleteSelectedShape() {
            const selectedNodes = transformer.nodes();
            if (selectedNodes.length === 0) return;
            
            selectedNodes.forEach(node => {
                node.destroy();
            });
            
            transformer.nodes([]);
            roomLayer.draw();
            document.getElementById('coordsInfo').innerHTML = "坐标信息会显示在这里";
        }

        // 清空画布
        function clearCanvas() {
            const shapes = roomLayer.find('Shape');
            shapes.each(shape => {
                if (shape !== floorRect && shape !== transformer) {
                    shape.destroy();
                }
            });
            
            transformer.nodes([]);
            roomLayer.draw();
            document.getElementById('coordsInfo').innerHTML = "坐标信息会显示在这里";
        }

        // 更新坐标信息显示
        function updateCoordsInfo() {
            const selectedNodes = transformer.nodes();
            if (selectedNodes.length === 0) {
                document.getElementById('coordsInfo').innerHTML = "坐标信息会显示在这里";
                return;
            }
            
            const node = selectedNodes[0];
            let coordsText = "";
            
            if (node instanceof Konva.Rect) {
                coordsText = `矩形：<br>`;
                coordsText += `左上角：(${Math.round(node.x())}, ${Math.round(node.y())})<br>`;
                coordsText += `右上角：(${Math.round(node.x() + node.width())}, ${Math.round(node.y())})<br>`;
                coordsText += `左下角：(${Math.round(node.x())}, ${Math.round(node.y() + node.height())})<br>`;
                coordsText += `右下角：(${Math.round(node.x() + node.width())}, ${Math.round(node.y() + node.height())})<br>`;
                coordsText += `宽度：${Math.round(node.width())}，高度：${Math.round(node.height())}`;
            } else if (node instanceof Konva.Circle) {
                coordsText = `圆形：<br>`;
                coordsText += `中心点：(${Math.round(node.x())}, ${Math.round(node.y())})<br>`;
                coordsText += `半径：${Math.round(node.radius())}`;
            } else if (node instanceof Konva.Line && node.closed()) {
                coordsText = `多边形：<br>`;
                const points = node.points();
                for (let i = 0; i < points.length; i += 2) {
                    const absX = Math.round(node.x() + points[i]);
                    const absY = Math.round(node.y() + points[i + 1]);
                    coordsText += `点${i/2 + 1}：(${absX}, ${absY})<br>`;
                }
            } else if (node instanceof Konva.Star) {
                coordsText = `星形：<br>`;
                coordsText += `中心点：(${Math.round(node.x())}, ${Math.round(node.y())})<br>`;
                coordsText += `外半径：${Math.round(node.outerRadius())}<br>`;
                coordsText += `内半径：${Math.round(node.innerRadius())}`;
            }
            
            document.getElementById('coordsInfo').innerHTML = coordsText;
        }

        // 处理窗口大小变化
        window.addEventListener('resize', function() {
            const width = document.getElementById('canvas-container').clientWidth;
            const height = document.getElementById('canvas-container').clientHeight;
            
            stage.width(width);
            stage.height(height);
            
            // 调整楼层大小和位置
            const floorWidth = Math.min(width * 0.8, height * 0.8);
            const floorHeight = floorWidth * 0.75;
            
            floorRect.setAttrs({
                x: (width - floorWidth) / 2,
                y: (height - floorHeight) / 2,
                width: floorWidth,
                height: floorHeight
            });
            
            floorLayer.batchDraw();
            roomLayer.batchDraw();
            tempLayer.batchDraw();
        });

        // 默认选择"选择"工具
        document.getElementById('select').click();
    </script>
</body>
</html>
